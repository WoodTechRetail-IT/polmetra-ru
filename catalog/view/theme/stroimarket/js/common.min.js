/* More menu JS */
!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){var i,n=e(window).width(),l=e(window).height(),t=[];e(window).resize(function(){clearTimeout(i),i=setTimeout(function(){e(window).width()===n&&e(window).height()===l||(e(t).each(function(){e(this).flexMenu({undo:!0}).flexMenu(this.options)}),n=e(window).width(),l=e(window).height())},200)}),e.fn.flexMenu=function(i){var n,l=e.extend({threshold:2,cutoff:2,linkText:"More",linkTitle:"View More",linkTextAll:"Menu",linkTitleAll:"Open/Close Menu",shouldApply:function(){return!0},showOnHover:!0,popupAbsolute:!0,popupClass:"",undo:!1},i);return this.options=l,(n=e.inArray(this,t))>=0?t.splice(n,1):t.push(this),this.each(function(){var i,n,t,o,f,u,s=e(this),d=s.find("> li"),r=d.first(),a=d.last(),p=d.length,h=Math.floor(r.offset().top),c=Math.floor(r.outerHeight(!0)),v=!1;function M(e){return Math.ceil(e.offset().top)>=h+c}if(M(a)&&p>l.threshold&&!l.undo&&s.is(":visible")&&l.shouldApply()){var w=e('<ul class="flexMenu-popup" style="display:none;'+(l.popupAbsolute?" left: auto; right: 0;":"")+'"></ul>');for(w.addClass(l.popupClass),u=p;u>1;u--){if(n=M(i=s.find("> li:last-child")),u-1<=l.cutoff){e(s.children().get().reverse()).appendTo(w),v=!0;break}if(!n)break;i.appendTo(w)}v?s.append('<li class="flexMenu-viewMore flexMenu-allInPopup"><a href="#" title="'+l.linkTitleAll+'">'+l.linkTextAll+"</a></li>"):s.append('<li class="flexMenu-viewMore"><a href="#" title="'+l.linkTitle+'">'+l.linkText+"</a></li>"),M(t=s.find("> li.flexMenu-viewMore"))&&s.find("> li:nth-last-child(2)").appendTo(w),w.children().each(function(e,i){w.prepend(i)}),t.append(w),s.find("> li.flexMenu-viewMore > a").click(function(i){var n;n=t,e("li.flexMenu-viewMore.active").not(n).removeClass("active").find("> ul").hide(),w.toggle(),t.toggleClass("active"),i.preventDefault()}),e(document).click(function(i){e(i.target).closest(t).length||(w.hide(),t.removeClass("active"),i.stopPropagation())}),l.showOnHover&&"undefined"!=typeof Modernizr&&!Modernizr.touch&&t.hover(function(){w.show(),e(this).addClass("active")},function(){w.hide(),e(this).removeClass("active")})}else if(l.undo&&s.find("ul.flexMenu-popup")){for(o=(f=s.find("ul.flexMenu-popup")).find("li").length,u=1;u<=o;u++)f.find("> li:first-child").appendTo(s);f.remove(),s.find("> li.flexMenu-viewMore").remove()}})}});

/* Main JS theme */
$(document).ready(function() {
    catalog_quantity(),
    product_quantity(),
    scroll_top(),
    tooltip(),
    collapse(),
    column(),
    mobile_search(),
    desctop_search(),
    language(),
    currency(),
    review_rating(),
    mobile_close(),
    check_resize(),
    mobile_scroll(),
    desctop_scroll(),
    product_hover(),
    cart_hover(),
    text_danger(),
    menu_type_vertical()
});

function getURLVar(key) {
    var value = [];

    var query = String(document.location).split('?');

    if (query[1]) {
        var part = query[1].split('&');

        for (i = 0; i < part.length; i++) {
            var data = part[i].split('=');

            if (data[0] && data[1]) {
                value[data[0]] = data[1];
            }
        }

        if (value[key]) {
            return value[key];
        } else {
            return '';
        }
    }
}

function menu_type_vertical() {
    $(".catalog-button").click(function () {
		$(this).toggleClass("active"),
        $("body").append('<div class="menu-shadow"></div>'),
		$(".header-nav__submenu").toggleClass("show"),
        $("body").addClass('modal-open')
	});

    $('body').on('click', '.menu-shadow', function () {
		$(".header-nav__submenu").removeClass("show"),
        $(this).remove(),
        $("body").removeClass('modal-open')
	});

	$(".header-submenu__close").click(function () {
		$(".header-nav__submenu").removeClass("show"),
        $('.menu-shadow').remove(),
        $("body").removeClass('modal-open')
	});

	$(".header-submenu__leftside").find(".header-submenu__item:first").addClass("active");
	$(".header-submenu__rightside").find(".header-submenu__block:first").addClass("active");
	$(".header-submenu__col--grey li").hover(function () {
		var root_id = $(this).data("id");
		$(".header-submenu__leftside li").removeClass("active");
		$(this).addClass("active");
		$(".header-submenu__rightside .header-submenu__block").removeClass("active")
		$(".header-submenu__rightside .header-submenu__block[data-id='" + root_id + "']").addClass("active")
	});

	$(".menu-toggle").click(function () {
        $('.catalog-category').css({'transform': 'translateX(-100%)'}),
        $("body").addClass('modal-open')
	});

	$(".mobile-catalog__close").click(function () {
		$(".mobile-catalog").removeAttr("style"),
        $("body").removeClass('modal-open')
	});

	$(".mobile-catalog__item.has-item > .mobile-item").click(function () {
		$(this).next().css({'transform': 'translateX(-100%)'})
	});

	$(".mobile-catalog__back").click(function () {
		$(this).parent().parent().removeAttr("style")
	});

	$(".mobile-catalog__link").click(function () {
		return document.location.href = $(this).data("link"), !1
	});

    $(".top-panel__informer").click(function () {
		$(".menu-mobile__informations").css({'transform': 'translateX(-100%)'}),
        $("body").addClass('modal-open')
	});

    $(".slide-close").click(function () {
		$(".menu-mobile__informations").removeAttr("style"),
        $("body").removeClass('modal-open')
	});

}

function text_danger() {
    $(".text-danger").each(function() {
        var a = $(this).parent().parent();
        a.hasClass("form-group") && a.addClass("has-error")
    })
}

function cart_hover() {
    if (window.matchMedia("(min-width: 992px)").matches) {
        var n;

        function t() {
            $(".cart-panel").stop(!1, !1).fadeIn(300)
        }

        function i() {
            $(".cart-panel").stop(!1, !1).fadeOut(300)
        }
        $(".top-panel__mini-cart").hover(function() {
            n || (n = window.setTimeout(function() {
                n = null,
                t()
            }, 200))
        }, function() {
            n ? (window.clearTimeout(n),
            n = null) : i()
        }),
        $("#mini-cart").hover(function() {
            t()
        }, function() {
            i()
        })
    }
}

function product_hover() {
    window.matchMedia("(min-width: 992px)").matches && $(".product-item__container").hover(function() {
        $(this).addClass("hover")
    }, function() {
        $(this).removeClass("hover")
    })
}

function desctop_scroll() {
    window.matchMedia("(min-width: 992px)").matches && $(window).scroll(function() {
        $(this).scrollTop() > 40 ? (
            $(".top-panel__wrapper").addClass("active"),
            $(".top-panel").addClass("fixed"),
            $(".cart-panel").addClass("top")
        ) : (
            $(".top-panel").removeClass("fixed"),
            $(".top-panel__wrapper").removeClass("active"),
            $(".cart-panel").removeClass("top")
        )
    })
}

function mobile_scroll() {
    window.matchMedia("(max-width: 991px)").matches && (
        $(".catalog-menu__wrapper").addClass("scrollbar"),
        $(window).scroll(function() {
            $(this).scrollTop() > 186 ? (
                $(".top-panel__tfoot, .catalog-wrapper.sort").addClass("active")
            ) : $(this).scrollTop() < 136 && (
                $(".top-panel__tfoot, .catalog-wrapper.sort").removeClass("active")
            )
        })
    )
}

function check_resize() {
    $(window).width() <= 991 ? ($("body").addClass("mobile"),
    $(".top-panel__tfoot").addClass("is-top"),
    $(".top-panel__wrapper").removeClass("visible"),
    $(".catalog-menu").removeClass("navmenu")) : ($("body").addClass("desctop"),
    $(".top-panel__tfoot").removeClass("is-top"),
    $(".top-panel__wrapper").addClass("visible"),
    $(".catalog-menu").addClass("navmenu"))
}

function mobile_close() {
    $(".slide-close").click(function() {
        $("body").removeClass("overflow-hidden"),
        $(".slide-search,.menu-control,.menu-mobile__informations").removeClass("active"),
        $(".site-menu__horizontal .menu-toggle").removeClass("showToggle"),
        $(".catalog-menu li").removeClass("open"),
        $(".catalog-menu-dropdown-menu").slideUp(200)
    })
}

function review_rating() {
    $(".stars-rating span").click(function() {
        var t = $(this).attr("data-rate");
        $(".stars-rating .wrap").attr("data-rate", t),
        $("#s_rating").val(t)
    })
}

function currency() {
    window.matchMedia("(max-width: 991px)").matches && ($("#form-language").appendTo(".mobile-language"))
    $("#form-currency .currency-select").on("click", function(c) {
        c.preventDefault(),
        $("#form-currency input[name='code']").val($(this).attr("name")),
        $("#form-currency").submit()
    })
}

function language() {
    window.matchMedia("(max-width: 991px)").matches && ($("#form-currency").appendTo(".mobile-currency"))
    $("#form-language .language-select").on("click", function(b) {
        b.preventDefault();
        $("#form-language input[name='code']").val($(this).attr("name"));
        $("#form-language").submit()
    })
}

function desctop_search() {
    $(".top-panel__search input[name='search']").parent().find("button").on("click", function() {
        var e = $("base").attr("href") + "index.php?route=product/search"
          , n = $(".top-panel__search input[name='search']").val();
        n && (e += "&search=" + encodeURIComponent(n)),
        location = e
    }),
    $(".top-panel__search input[name='search']").on("keydown", function(e) {
        13 == e.keyCode && $(".top-panel__search input[name='search']").parent().find("button").trigger("click")
    })
}

function mobile_search() {
    window.matchMedia("(max-width: 991px)").matches && ($(".top-panel__search").appendTo(".search-control-mobile"))
    $(".top-panel__search-btn").click(function() {
        $("body").addClass("overflow-hidden"),
        $(".slide-search").addClass("active")
    })
}

function column() {
    // Product List
	$('#list-view').click(function() {
		$('#content .row > .product-grid').attr('class', 'product-layout product-list col-12');
		$('#grid-view').removeClass('active');
		$('#list-view').addClass('active');

		localStorage.setItem('display', 'list');
	});

	// Product Grid
	$('#grid-view').click(function() {
		// What a shame bootstrap does not take into account dynamically loaded columns
		var cols = $('#column-right, #column-left').length;

		if (cols == 2) {
			$('#content .product-list').attr('class', 'product-layout product-grid col-xl-6 col-lg-6 col-md-6 col-sm-12 col-6');
		} else if (cols == 1) {
			$('#content .product-list').attr('class', 'product-layout product-grid col-xl-3 col-lg-4 col-md-6 col-sm-6 col-6');
		} else {
			$('#content .product-list').attr('class', 'product-layout product-grid col-xl-3 col-lg-3 col-md-3 col-sm-6 col-6');
		}

		$('#list-view').removeClass('active');
		$('#grid-view').addClass('active');

		localStorage.setItem('display', 'grid');
	});

	if (localStorage.getItem('display') == 'list') {
		$('#list-view').trigger('click');
		$('#list-view').addClass('active');
	} else {
		$('#grid-view').trigger('click');
		$('#grid-view').addClass('active');
	}
}

function collapse() {
    $(document).on("keydown", "#collapse-checkout-option input[name='email'], #collapse-checkout-option input[name='password']", function(o) {
        13 == o.keyCode && $("#collapse-checkout-option #button-login").trigger("click")
    })
}

function tooltip() {
    $("[data-toggle='tooltip']").tooltip({
        container: "body"
    }),
    $(document).ajaxStop(function() {
        $("[data-toggle='tooltip']").tooltip({
            container: "body"
        })
    })
}

function catalog_quantity() {
    $(".product-item__amount-input").each(function() {
        $("body").on("input", ".product-item__amount-input", function() {
            this.value.match(/[^0-9]/g) && (this.value = this.value.replace(/[^0-9]/g, ""))
        });
        var t = $(this).val()
          , i = $(this).attr("data-maximum");
        $(this).prev().attr("disabled", !0),
        $(this).next().click(function() {
            $(this).prev().prev().attr("disabled", !1),
            $(this).prev().val(1 + ~~$(this).prev().val()),
            ~~$(this).prev().val() == ~~i && $(this).attr("disabled", !0)
        }),
        $(this).prev().click(function() {
            $(this).next().next().attr("disabled", !1),
            $(this).next().val() > ~~t ? $(this).next().val(~~$(this).next().val() - 1) : $(this).attr("disabled", !0)
        })
    })
}

function product_quantity() {
    var t = $(".counter-input").data("min")
      , a = $(".counter-input").data("max")
      , i = $(".counter").find("input")
      , d = $(".counter-plus")
      , e = $(".counter-minus").attr("disabled", !0)
      , r = $("#button-cart");
    d.click(function() {
        var t = parseInt(i.val()) + 1;
        i.val(t),
        0 != a && t >= a && d.attr("disabled", !0),
        e.attr("disabled", !1)
    }),
    e.click(function() {
        var a = parseInt(i.val()) - 1;
        i.val(a),
        a <= t && e.attr("disabled", !0),
        d.attr("disabled", !1)
    }),
    $("body").on("input", ".counter-input", function() {
        this.value.match(/[^0-9]/g) && (this.value = this.value.replace(/[^0-9]/g, ""));
        var i = this.value;
        "" == i && (d.attr("disabled", !0),
        e.attr("disabled", !0),
        r.attr("disabled", !0)),
        i >= t && (d.attr("disabled", !1),
        e.attr("disabled", !1),
        r.attr("disabled", !1)),
        1 == i && e.attr("disabled", !0),
        i > a && (d.attr("disabled", !0),
        this.value = a)
    })
}

function scroll_top() {
    var o = $(".scroll-up");
    $(window).scroll(function() {
        $(window).scrollTop() > 300 ? $(".scroll-up").css("bottom", "22px") : $(".scroll-up").removeAttr("style")
    }),
    o.on("click", function(o) {
        o.preventDefault(),
        $("html, body").animate({
            scrollTop: 0
        }, "300")
    })
}

var cart = {
    'add': function(product_id, quantity) {
        $.ajax({
            url: 'index.php?route=checkout/cart/add',
            type: 'post',
            data: 'product_id=' + product_id + '&quantity=' + (typeof (quantity) != 'undefined' ? quantity : 1),
            dataType: 'json',
            success: function(json) {
                $('.alert-dismissible, .text-danger').remove();
                if (json['redirect']) {
                    location = json['redirect'];
                }
                if (json['success']) {
                    setTimeout(function() {
                        $("body").append('<div class="alert alert-top alert-cart alert-dismissible"><i class="fi fi-rr-check"></i>' + json['success'] + '<button type="button" class="close" data-dismiss="alert">×</button></div>');
                        if (window.innerWidth >= 992) {
                            $(".alert-top").animate({
                                top: 44
                            }, 100)
                        } else {
                            $(".alert-top").animate({
                                top: 0
                            }, 100)
                        }
                        $(".cart-count").html(json['cart_total']);
                        $('.panel-cart').removeClass('cart-empty');
                    }, 100);
                    $(".cart-panel").load("index.php?route=common/cart/info .cart-panel > *");
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    },
    'update': function(key, quantity) {
        $.ajax({
            url: 'index.php?route=checkout/cart/edit',
            type: 'post',
            data: 'key=' + key + '&quantity=' + (typeof (quantity) != 'undefined' ? quantity : 1),
            dataType: 'json',
            success: function(json) {
                // Need to set timeout otherwise it wont update the total
                setTimeout(function() {
                    $(".cart-count").html(json['cart_total']);
                    $('.panel-cart').removeClass('cart-empty');
                }, 100);
                if (getURLVar('route') == 'checkout/cart' || getURLVar('route') == 'checkout/checkout') {
                    location = 'index.php?route=checkout/cart';
                } else {
                    $(".cart-panel").load("index.php?route=common/cart/info .cart-panel > *");
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    },
    'remove': function(key) {
        $.ajax({
            url: 'index.php?route=checkout/cart/remove',
            type: 'post',
            data: 'key=' + key,
            dataType: 'json',
            success: function(json) {
                // Need to set timeout otherwise it wont update the total
                setTimeout(function() {
                    $(".cart-count").html(json['cart_total']);
                    $('.panel-cart').removeClass('cart-empty');
                }, 100);
                if (getURLVar('route') == 'checkout/cart' || getURLVar('route') == 'checkout/checkout') {
                    location = 'index.php?route=checkout/cart';
                } else {
                    $(".cart-panel").load("index.php?route=common/cart/info .cart-panel > *");
                }
                location.reload();
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    }
}

var voucher = {
    'add': function() {
    },
    'remove': function(key) {
        $.ajax({
            url: 'index.php?route=checkout/cart/remove',
            type: 'post',
            data: 'key=' + key,
            dataType: 'json',
            success: function(json) {
                // Need to set timeout otherwise it wont update the total
                setTimeout(function() {
                    $(".cart-count").html(json['cart_total']);
                    $('.panel-cart').removeClass('cart-empty');
                }, 100);
                if (getURLVar('route') == 'checkout/cart' || getURLVar('route') == 'checkout/checkout') {
                    location = 'index.php?route=checkout/cart';
                } else {
                    $(".cart-panel").load("index.php?route=common/cart/info .cart-panel > *");
                }
                location.reload();
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    }
}

var wishlist = {
    'add': function(product_id) {
        $.ajax({
            url: 'index.php?route=account/wishlist/add',
            type: 'post',
            data: 'product_id=' + product_id,
            dataType: 'json',
            success: function(json) {
                $('.alert-dismissible').remove();
                if (json['redirect']) {
                    location = json['redirect'];
                }
                if (json['success']) {
                    $("body").append('<div class="alert alert-wish alert-dismissible"><i class="fi fi-rr-check"></i>' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">×</button></div>');
                    if (window.innerWidth >= 992) {
                        $(".alert-wish").animate({
                            top: 44
                        }, 100)
                    } else {
                        $(".alert-wish").animate({
                            top: 0
                        }, 100)
                    }
                }
                $(".wishlist-count").html(json['wishlist_total']);
                $('.panel-wishlist').removeClass('wishlist-empty');
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    },
    'remove': function() {}
}

var compare = {
    'add': function(product_id) {
        $.ajax({
            url: 'index.php?route=product/compare/add',
            type: 'post',
            data: 'product_id=' + product_id,
            dataType: 'json',
            success: function(json) {
                $('.alert-dismissible').remove();
                if (json['success']) {
                    $("body").append('<div class="alert alert-comp alert-dismissible"><i class="fi fi-rr-check"></i>' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">×</button></div>');
                    $('.compare-count').html(json['compare_total']);
                    $('.panel-compare').removeClass('compare-empty');
                    if (window.innerWidth >= 992) {
                        $(".alert-comp").animate({
                            top: 44
                        }, 100)
                    } else {
                        $(".alert-comp").animate({
                            top: 0
                        }, 100)
                    }
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    },
    'remove': function() {}
}

// Agree to Terms
$(document).delegate(".agree", "click", function(t) {
    t.preventDefault(),
    $("#modal-agree").remove();
    var l = this;
    $.ajax({
        url: $(l).attr("href"),
        type: "get",
        dataType: "html",
        success: function(t) {
            html = '<div id="modal-agree" class="modal fade">',
            html += '  <div class="modal-dialog">',
            html += '    <div class="modal-content">',
            html += '      <div class="modal-header">',
            html += '        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>',
            html += '        <h4 class="modal-title">' + $(l).text() + "</h4>",
            html += "      </div>",
            html += '      <div class="modal-body">' + t + "</div>",
            html += "    </div>",
            html += "  </div>",
            html += "</div>",
            $("body").append(html),
            $("#modal-agree").modal("show")
        }
    })
});

// Autocomplete */
(function($) {
	$.fn.autocomplete = function(option) {
		return this.each(function() {
			this.timer = null;
			this.items = new Array();

			$.extend(this, option);

			$(this).attr('autocomplete', 'off');

			// Focus
			$(this).on('focus', function() {
				this.request();
			});

			// Blur
			$(this).on('blur', function() {
				setTimeout(function(object) {
					object.hide();
				}, 200, this);
			});

			// Keydown
			$(this).on('keydown', function(event) {
				switch(event.keyCode) {
					case 27: // escape
						this.hide();
						break;
					default:
						this.request();
						break;
				}
			});

			// Click
			this.click = function(event) {
				event.preventDefault();

				value = $(event.target).parent().attr('data-value');

				if (value && this.items[value]) {
					this.select(this.items[value]);
				}
			}

			// Show
			this.show = function() {
				var pos = $(this).position();

				$(this).siblings('ul.dropdown-menu').css({
					top: pos.top + $(this).outerHeight(),
					left: pos.left
				});

				$(this).siblings('ul.dropdown-menu').show();
			}

			// Hide
			this.hide = function() {
				$(this).siblings('ul.dropdown-menu').hide();
			}

			// Request
			this.request = function() {
				clearTimeout(this.timer);

				this.timer = setTimeout(function(object) {
					object.source($(object).val(), $.proxy(object.response, object));
				}, 200, this);
			}

			// Response
			this.response = function(json) {
				html = '';

				if (json.length) {
					for (i = 0; i < json.length; i++) {
						this.items[json[i]['value']] = json[i];
					}

					for (i = 0; i < json.length; i++) {
						if (!json[i]['category']) {
							html += '<li data-value="' + json[i]['value'] + '"><a href="#">' + json[i]['label'] + '</a></li>';
						}
					}

					// Get all the ones with a categories
					var category = new Array();

					for (i = 0; i < json.length; i++) {
						if (json[i]['category']) {
							if (!category[json[i]['category']]) {
								category[json[i]['category']] = new Array();
								category[json[i]['category']]['name'] = json[i]['category'];
								category[json[i]['category']]['item'] = new Array();
							}

							category[json[i]['category']]['item'].push(json[i]);
						}
					}

					for (i in category) {
						html += '<li class="dropdown-header">' + category[i]['name'] + '</li>';

						for (j = 0; j < category[i]['item'].length; j++) {
							html += '<li data-value="' + category[i]['item'][j]['value'] + '"><a href="#">&nbsp;&nbsp;&nbsp;' + category[i]['item'][j]['label'] + '</a></li>';
						}
					}
				}

				if (html) {
					this.show();
				} else {
					this.hide();
				}

				$(this).siblings('ul.dropdown-menu').html(html);
			}

			$(this).after('<ul class="dropdown-menu"></ul>');
			$(this).siblings('ul.dropdown-menu').delegate('a', 'click', $.proxy(this.click, this));

		});
	}
})(window.jQuery);